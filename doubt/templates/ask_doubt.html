{% extends "base.html" %}
{% block start %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
  body {
    background: #f9fafc;
    font-family: 'Poppins', sans-serif;
    color: #333;
  }

  /* Gradient Title */
  h4.gradient-title, h5.gradient-title {
    background: linear-gradient(90deg, #2563eb, #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 800;
  }

  /* Form Card */
  .form-section {
    background: #ffffff;
    padding: 28px;
    border-radius: 18px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
  }
  .form-section:hover {
    transform: translateY(-4px);
  }

  .form-label {
    font-weight: 600;
    color: #444;
  }

  .form-control, .form-select {
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    background: #fff;
    color: #111;
    font-weight: 500;
  }
  .form-control:focus, .form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(37,99,235,.25);
    border-color: #2563eb;
  }

  /* Button */
  .btn-primary {
    background: linear-gradient(90deg, #2563eb, #7c3aed);
    border: none;
    border-radius: 10px;
    font-weight: 600;
    transition: all .3s;
    padding: 10px 22px;
  }
  .btn-primary:hover {
    background: linear-gradient(90deg, #7c3aed, #2563eb);
    transform: translateY(-2px);
  }

  /* Table Card */
  .card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    color: #333;
    box-shadow: 0 6px 15px rgba(0,0,0,0.06);
    border-radius: 15px;
  }

  .table th {
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .3px;
    background: #f1f5f9 !important;
    color: #111;
  }
  .table td {
    border-color: #e5e7eb;
  }
  .table-hover tbody tr:hover {
    background: #f9fafc;
  }

  /* Badge Styling */
  .badge {
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 600;
  }
</style>

<div class="container py-4">
  <h4 class="text-center fw-bold mb-4 gradient-title animate__animated animate__fadeInDown">
    <i class="bi bi-patch-question-fill"></i> Ask Your Doubt
  </h4>

  <!-- Django Messages -->
  {% if messages %}
      {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm fw-bold" role="alert">
              {% if message.tags == 'success' %}✅ {{ message }}
              {% elif message.tags == 'error' %}❌ {{ message }}
              {% elif message.tags == 'warning' %}⚠️ {{ message }}
              {% elif message.tags == 'info' %}ℹ️ {{ message }}
              {% endif %}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
      {% endfor %}
  {% endif %}

  <div class="row justify-content-center align-items-start">
    <!-- Doubt Form -->
    <div class="col-md-8 animate__animated animate__fadeInLeft">
      <div class="form-section">
        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-chat-dots-fill"></i> Your Doubt</label>
            <textarea name="doubt" class="form-control" rows="2" placeholder="Type your doubt here..." required></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="bi bi-card-text"></i> Description</label>
            <textarea name="description" class="form-control" rows="2" placeholder="Additional info (if any)"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="bi bi-person-badge-fill"></i> Select Teacher</label>
            <select name="teacher" class="form-select" required>
              <option value="">-- Choose Teacher --</option>
              {% for teacher in all_Users %}
              {% if teacher.role == 'Teacher' %}
              <option value="{{ teacher.first_name }}">{{ teacher.first_name }} {{ teacher.last_name }}, Sir</option>
              {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="bi bi-book-half"></i> Select Subject</label>
            <select name="subject" class="form-select" required>
              <option value="">-- Choose Subject --</option>
              {% for value,lable in subject_select %}
              <option value="{{ value }}">{{ lable }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="bi bi-image-fill"></i> Optional Image</label>
            <input type="file" name="image" class="form-control">
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-send-fill"></i> Submit
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Doubt History Table -->
  <div class="card p-4 mt-5 animate__animated animate__fadeInUp">
    <h5 class="mb-3 gradient-title"><i class="bi bi-journal-text"></i> My Doubt History</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-striped align-middle small">
        <thead>
          <tr>
            <th>#</th>
            <th><i class="bi bi-chat-left-text-fill"></i> Doubt</th>
            <th><i class="bi bi-card-text"></i> Description</th>
            <th><i class="bi bi-person"></i> Teacher</th>
            <th><i class="bi bi-image"></i> Image</th>
            <th><i class="bi bi-check2-circle"></i> Status</th>
            <th><i class="bi bi-calendar-event-fill"></i> Asked On</th>
          </tr>
        </thead>
        <tbody>
          {% for doubt in doubts %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ doubt.decrypted_name }}</td>
            <td>{{ doubt.decrypted_description | truncatewords:20 }}</td>
            <td>{{ doubt.teacher_select }}</td>
            <td>
              {% if doubt.doubt_image %}
              <a href="{{ doubt.doubt_image.url }}" target="_blank" class="text-primary fw-bold">View</a>
              {% else %} - {% endif %}
            </td>
            <td>
              {% if doubt.status == 'resolved' %}
              <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> Resolved</span>
              {% else %}
              <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i> Pending</span>
              {% endif %}
            </td>
            <td>{{ doubt.created_at|date:"d M Y H:i" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center fw-bold">No doubts asked yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
